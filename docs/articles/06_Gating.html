<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>06 Gating • AutoSpectral</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="06 Gating">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">AutoSpectral</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/01_Full_AutoSpectral_Workflow.html">01 Full Workflow Example</a></li>
    <li><a class="dropdown-item" href="../articles/02_Control_File_example.html">02 Creating the control file</a></li>
    <li><a class="dropdown-item" href="../articles/03_Aurora_example.html">03 Aurora AutoSpectral Example</a></li>
    <li><a class="dropdown-item" href="../articles/04_ID7000_WLS_example.html">04 ID7000 WLS Example</a></li>
    <li><a class="dropdown-item" href="../articles/05_Preparing_Controls.html">05 Preparing Controls</a></li>
    <li><a class="dropdown-item" href="../articles/06_Gating.html">06 Gating</a></li>
    <li><a class="dropdown-item" href="../articles/07_Cleaning.html">07 Control clean-up</a></li>
    <li><a class="dropdown-item" href="../articles/08_Single_Cell_AutoFluorescence.html">08 Single Cell Autofluorescence</a></li>
    <li><a class="dropdown-item" href="../articles/09_Per_Cell_Optimization.html">09 Per Cell Optimization</a></li>
    <li><a class="dropdown-item" href="../articles/10_Reload_AutoSpectral.html">10 Re-running AutoSpectral</a></li>
    <li><a class="dropdown-item" href="../articles/11_Plotting.html">11 Plotting</a></li>
    <li><a class="dropdown-item" href="../articles/12_Speed_It_Up.html">12 Speed It Up (Why So Slow?)</a></li>
    <li><a class="dropdown-item" href="../articles/13_Updates_And_Issues.html">13 Updates and Issues</a></li>
    <li><a class="dropdown-item" href="../articles/14_Development.html">14 Development</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/DrCytometer/AutoSpectral/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>06 Gating</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DrCytometer/AutoSpectral/blob/HEAD/vignettes/articles/06_Gating.Rmd" class="external-link"><code>vignettes/articles/06_Gating.Rmd</code></a></small>
      <div class="d-none name"><code>06_Gating.Rmd</code></div>
    </div>

    
    
<p>In this article, we’ll try to cover some of the features and tuning
for the automated gating in AutoSpectral. This was developed by Carlos
Roca in AutoSpill, and has been lightly modified for use in
AutoSpectral. To be fair, this is one of the weaker points, largely
because of the immense variability in sample types that people may have
and the even bigger variability in opinions on how to set up the
appearance of your scatter plots. So, a one-size-fits-all approach is
never going to work. I’m working on an alternative, but this will
require quite a bit of testing before it can implemented.</p>
<p>Gating to identify the correct cells for the single-stained controls
is really important, though. We’ll look at common failure points, how to
get the gates to look the way you want and also cover how to skip the
gating entirely. For the latter, you can just import pre-gated files
exported from your favorite FCS analysis program.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DrCytometer/AutoSpectral" class="external-link">AutoSpectral</a></span><span class="op">)</span></span></code></pre></div>
<p>As always, we’ll start by loading in the parameters and telling
AutoSpectral where the control files are. Today we’re going to use a
couple samples from the ID7000, largely because this particular machine
didn’t allow us to set a threshold on scatter without messing up the
data, and the FSC gain was maxed out. According to the engineer, nothing
was wrong with it (yay! anyway…). You can get the data from Mendeley
(see AutoSpectral: 40-colour ID7000 dataset).</p>
<p>Today I’m including a simple set with a bead control and a cell
control for Spark Blue 574 (anti-CD14), with corresponding unstained
samples.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.autospectral.param.html">get.autospectral.param</a></span><span class="op">(</span>cytometer <span class="op">=</span> <span class="st">"id7000"</span>, figures <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">control.dir</span> <span class="op">&lt;-</span> <span class="st">"~/AutoSpectral_data/Gating_example/SSC"</span></span>
<span><span class="fu"><a href="../reference/create.control.file.html">create.control.file</a></span><span class="op">(</span><span class="va">control.dir</span>, <span class="va">asp</span><span class="op">)</span></span></code></pre></div>
<p>We get a warning because there are two fluorophores with the same
name (two copies of SB574). That’s intended to happen, but can probably
be changed later. For now, we can disambiguate the two by calling one of
the SB574 dyes <code>SB574 beads</code> and the other
<code>SB574 cells</code>. We’ll set universal negatives, fill in
<code>CD14</code> for the marker for both, and change the unstained bead
control <code>Fluorophore</code> to be <code>Negative</code> instead of
<code>AF</code>.</p>
<p>Once done, we can load in the control file.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">control.file</span> <span class="op">&lt;-</span> <span class="st">"~/AutoSpectral_data/Gating_example/fcs_control_file.csv"</span></span></code></pre></div>
<p>Now we are ready to read in the fcs files, gate the cells and
organize the experiment.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flow.control</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define.flow.control.html">define.flow.control</a></span><span class="op">(</span><span class="va">control.dir</span>, <span class="va">control.file</span>, <span class="va">asp</span><span class="op">)</span></span></code></pre></div>
<p>Check the gating plots. The ones with lots of numbered points on them
are the ones that define the automated gating. These are the most
important for troubleshooting. These are done on composite files,
aggregated between all samples that have been determined to share the
same gate (the gating variables are beads/cells, large/small, viability
gate/live cell, so any combination of those).</p>
<p>Gating on the beads: <img src="figures/Gating_example_beads_nonViability_smallGate.jpg" alt="Bead gating plot"> This is what it is supposed to look like when
it is working well. The square <code>region</code> gate defines the area
around the highest density of events, and the gate border is the
smoothed line inside that. In this case, it’s pretty clearly picked the
bead population (1). Population 2 is bead doublets. Population 3 is
debris.</p>
<p>What about the cells? What do we want? We want a gate that includes
the monocyte region because we’re staining for CD14. Did we get
that?</p>
<p>CD14 gating failure 1: <img src="figures/Gating_example_failure1.jpg" alt="CD14 monocyte gating plot"> Nope. Not even close.</p>
<p>What’s going on? AutoSpectral looks for the cells within a boundary
(expecting the cells to be up a bit off the axis) and expects there to
be a debris/dead cell population in the lower left corner. Neither of
these is really true in this case.</p>
<p>The parameters for controlling the search and gate definition are in
the functions that create the AutoSpectral parameter list, usually
defined, as here, as <code>asp</code>.</p>
<p>If we open up the main function, e.g.,
<code>View(get_autospectral_param_minimal)</code>, you can see a lot of
these starting at the comment <code>### gating parameters</code>.</p>
<p>Let’s start with the easiest fix: the target to pick. In this case,
AutoSpectral has found our cells (population 1), but it’s picking
population 2 as the one to use for defining the gate. This is controlled
by this parameter:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asp</span><span class="op">$</span><span class="va">gate.bound.density.max.target.cells</span></span></code></pre></div>
<p>The target population is one more than this number for cells.
(Confusingly, but that’s the original syntax from AutoSpill.) So, it
picks population 2. If we want it to pick population 1, we can do
this:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asp</span><span class="op">$</span><span class="va">gate.bound.density.max.target.cells</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">flow.control</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define.flow.control.html">define.flow.control</a></span><span class="op">(</span><span class="va">control.dir</span>, <span class="va">control.file</span>, <span class="va">asp</span><span class="op">)</span></span></code></pre></div>
<p>CD14 gating after setting target to 0: <img src="figures/Gating_example_target0.jpg" alt="CD14 monocyte gating plot"> Cool. Progress.</p>
<p>Now we’ve got the cells in the boundary, but it’s mostly lymphocytes,
right? And we’ve got a monocyte (CD14) control. That’s not going to work
well. We’re going to need a bigger gate.</p>
<p>For that, we return to the control file. Here, we have the option to
specify <code>large.gate</code> as <code>TRUE</code> for each control as
we see fit.</p>
<p>Changing the control file: <img src="figures/Gating_example_setting_largeGate.jpg" alt="Setting large gate"></p>
<p>Okay, trying again: (We’ve already set the target to 0 and it stays
there until we change it or call <code>get.autospectral.param</code>
again and overwrite <code>asp</code>).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flow.control</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define.flow.control.html">define.flow.control</a></span><span class="op">(</span><span class="va">control.dir</span>, <span class="va">control.file</span>, <span class="va">asp</span><span class="op">)</span></span></code></pre></div>
<p>With a larger gate set: <img src="figures/Gating_example_target0_largeGate.jpg" alt="Larger gate"></p>
<p>The large.gate option does something pretty simple–it extends the
basic roundish gate upwards and outwards (to the top and to the right).
The amount by which it scales upwards and outwards is determined by the
parameters below, which are defined on a cytometer-specific basis, so in
this case, in <code>get.autospectral.param.id7000</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asp</span><span class="op">$</span><span class="va">large.gate.scaling.x</span></span>
<span><span class="va">asp</span><span class="op">$</span><span class="va">large.gate.scaling.y</span></span></code></pre></div>
<p>As we see above, the gate’s bigger than we need it to be. We could,
if we want, make it a bit smaller, like so:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asp</span><span class="op">$</span><span class="va">large.gate.scaling.x</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">asp</span><span class="op">$</span><span class="va">large.gate.scaling.y</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">flow.control</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define.flow.control.html">define.flow.control</a></span><span class="op">(</span><span class="va">control.dir</span>, <span class="va">control.file</span>, <span class="va">asp</span><span class="op">)</span></span></code></pre></div>
<p>With a medium-sized gate set: <img src="figures/Gating_example_Target0_mediumGate.jpg" alt="Medium gate"></p>
<p>As you’ve probably noticed, the gating is pretty slow. This is mostly
down to the calculations to determine the density. There are some other
ways of doing this that are faster, but less reliable. Happy for any
suggestions here. Happy for any suggestions here. From what I’ve seen,
this would be much faster in Python.</p>
<p>The parameters that can speed up the gate are below:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asp</span><span class="op">$</span><span class="va">gate.downsample.n.cells</span></span>
<span><span class="va">asp</span><span class="op">$</span><span class="va">gate.bound.density.grid.n.cells</span></span>
<span><span class="va">asp</span><span class="op">$</span><span class="va">gate.region.density.grid.n.cells</span></span>
<span><span class="va">asp</span><span class="op">$</span><span class="va">gate.region.max.density.grid.n.cells</span></span></code></pre></div>
<p>The first determines the number of cells to be used for calculating
the gates. This number, 100000, is about as low as is reliable, and you
may well need more cells if you do not have well-defined density
blobs.</p>
<p>The other three determine the grid size for searching for dense
populations. Larger grids, bigger search area, so slower. But, also,
better definition of the density, which determines both the boundaries
and the pseudocolor on the plots. Trying changing them around if you
want. Setting the grid.n to 50 often works quite well and is quite a bit
faster.</p>
<p>The other factor we’ll touch on controls the tightness of the
boundary. Basically, we can tune it based on the robust standard
deviation of the points in the region (as determined by tiling with
Voronoi tessellation). Bigger number, bigger gate.</p>
<p>With all of the parameters, we have a set for beads and a set for
cells. This allows us to tune the gates for each separately. For this
part, let’s tweak the bead gate.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asp</span><span class="op">$</span><span class="va">gate.bound.density.max.mad.factor.beads</span></span>
<span><span class="va">asp</span><span class="op">$</span><span class="va">gate.bound.density.max.mad.factor.cells</span></span></code></pre></div>
<p>By default, the bead gate is set to be a bit looser than the cells
(relative to the peak of density in the bead population). Beads are
cleaner, so we can be less stringent. Let’s be even less strict–what
happens?</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asp</span><span class="op">$</span><span class="va">gate.bound.density.max.mad.factor.beads</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">flow.control</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define.flow.control.html">define.flow.control</a></span><span class="op">(</span><span class="va">control.dir</span>, <span class="va">control.file</span>, <span class="va">asp</span><span class="op">)</span></span></code></pre></div>
<p>Bead gate with MAD = 3: <img src="figures/Gating_example_beads_nonViability_smallGate.jpg" alt="Default bead gate"></p>
<p>Bead gate with MAD set to 10: <img src="figures/Gating_example_beads_MAD10.jpg" alt="Altered bead gate">
With this, we expand the final search region (rectangle), but the final
gate for the beads is pretty similar due to the sharp cut-off in density
around the bead peak.</p>
<p>The other thing we can do to modify the gating is to change the
limits on FSC and SSC. This is pretty important for newer cytometers
like the BD FACSDiscover and Novocyte Opteon since they have very large
dynamic ranges. This makes it hard to get everything on screen and
scaled well without some manual intervention. AutoSpectral has default
settings on scatter that are specific to each cytometer, but, really, a
lot of this is down to personal preferences and the types of samples
you’re working with. So, let’s look at how to change the scales.</p>
<p>First, which scatter parameters are we using?</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asp</span><span class="op">$</span><span class="va">default.scatter.parameter</span></span></code></pre></div>
<p>For the ID7000, it’s FSC-A and SSC-A.</p>
<p>What if I have multiple scatter parameters and want to use something
else?</p>
<p>If this were another cytometer’s data, we could use a different
scatter detector. I’ve commented this out below, but that’s how you’d do
it.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># asp$default.scatter.parameter &lt;- c( "FSC-A", "SSC-B-A" )</span></span></code></pre></div>
<p>There are lower and upper limits for each scatter parameter.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asp</span><span class="op">$</span><span class="va">scatter.data.min.x</span></span>
<span><span class="va">asp</span><span class="op">$</span><span class="va">scatter.data.max.x</span></span>
<span><span class="va">asp</span><span class="op">$</span><span class="va">scatter.data.min.y</span></span>
<span><span class="va">asp</span><span class="op">$</span><span class="va">scatter.data.max.y</span></span></code></pre></div>
<p>The defaults are likely to be the entire dynamic range. For this
data, we’ve got the cells down in the lower left. We can try restricting
the range rather than changing the target population:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asp</span><span class="op">$</span><span class="va">gate.bound.density.max.target.cells</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="va">asp</span><span class="op">$</span><span class="va">scatter.data.max.x</span> <span class="op">&lt;-</span> <span class="fl">3e5</span></span>
<span></span>
<span><span class="va">asp</span><span class="op">$</span><span class="va">scatter.data.max.y</span> <span class="op">&lt;-</span> <span class="fl">4e5</span></span>
<span></span>
<span><span class="va">flow.control</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define.flow.control.html">define.flow.control</a></span><span class="op">(</span><span class="va">control.dir</span>, <span class="va">control.file</span>, <span class="va">asp</span><span class="op">)</span></span></code></pre></div>
<p>That works pretty well. This is often the best way to fix the gating.
It incorporates your human knowledge about what’s going on.</p>
<p>Lymphocyte gate with scatter limits changed: <img src="figures/Gating_example_scatterLimits_smallGate.jpg" alt="lymphocyte gate"></p>
<p>Monocyte-inclusive gate with scatter limits changed: <img src="figures/Gating_example_scatterLimits_largeGate.jpg" alt="Monocyte gate"></p>
<p>Bead gate with scatter limits changed: <img src="figures/Gating_example_scatterLimits_beads.jpg" alt="bead gate"></p>
<p>And, finally, we can just skip gating all together. For this, you’ll
probably want to gate first in FlowJo, FCS Express, SpectroFlo, etc.
Note that with FlowJo, this can occasionally mess up your files and will
almost certainly re-order your fluorescence detectors in alphabetical
order. The re-ordering can be a nuisance for plotting the spectra
(curves are all out of order) and for unmixing if your detectors from
the pre-gated controls are inconsistent with the names in the files to
be unmixed. Anyway, these are problems with FlowJo, so maybe try a
different program. I will be implementing a fix for that at some
point.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flow.control</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define.flow.control.html">define.flow.control</a></span><span class="op">(</span><span class="va">control.dir</span>, <span class="va">control.file</span>, <span class="va">asp</span>, gate <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>So much faster! We don’t get plots because we aren’t changing
anything and you should have already looked at the data before you did
this.</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Oliver Burton, Adrian Liston.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
