<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>12 Speed It Up (Why So Slow?) • AutoSpectral</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="12 Speed It Up (Why So Slow?)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">AutoSpectral</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/01_Full_AutoSpectral_Workflow.html">01 Full Workflow Example</a></li>
    <li><a class="dropdown-item" href="../articles/02_Control_File_example.html">02 Creating the control file</a></li>
    <li><a class="dropdown-item" href="../articles/03_Aurora_example.html">03 Aurora AutoSpectral Example</a></li>
    <li><a class="dropdown-item" href="../articles/04_ID7000_WLS_example.html">04 ID7000 WLS Example</a></li>
    <li><a class="dropdown-item" href="../articles/05_Preparing_Controls.html">05 Preparing Controls</a></li>
    <li><a class="dropdown-item" href="../articles/06_Gating.html">06 Gating</a></li>
    <li><a class="dropdown-item" href="../articles/07_Cleaning.html">07 Control clean-up</a></li>
    <li><a class="dropdown-item" href="../articles/08_Single_Cell_AutoFluorescence.html">08 Single Cell Autofluorescence</a></li>
    <li><a class="dropdown-item" href="../articles/09_Per_Cell_Optimization.html">09 Per Cell Optimization</a></li>
    <li><a class="dropdown-item" href="../articles/10_Reload_AutoSpectral.html">10 Re-running AutoSpectral</a></li>
    <li><a class="dropdown-item" href="../articles/11_Plotting.html">11 Plotting</a></li>
    <li><a class="dropdown-item" href="../articles/12_Speed_It_Up.html">12 Speed It Up (Why So Slow?)</a></li>
    <li><a class="dropdown-item" href="../articles/13_Updates_And_Issues.html">13 Updates and Issues</a></li>
    <li><a class="dropdown-item" href="../articles/14_Development.html">14 Development</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/DrCytometer/AutoSpectral/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>12 Speed It Up (Why So Slow?)</h1>
            
            <h4 data-toc-skip class="date">2026-02-10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/DrCytometer/AutoSpectral/blob/HEAD/vignettes/articles/12_Speed_It_Up.Rmd" class="external-link"><code>vignettes/articles/12_Speed_It_Up.Rmd</code></a></small>
      <div class="d-none name"><code>12_Speed_It_Up.Rmd</code></div>
    </div>

    
    
<p>AutoSpectral takes a lot longer to unmix files than standard OLS or
WLS unmixing approaches. Most of that is because it’s doing way more
calculations. If we consider a 40-color panel with a million cells,
there is essentially only a single computationally expensive inversion
to produce the unmixing matrix and then a second slow step applying that
to the data. In the per-cell optimization part of
<code><a href="../reference/unmix.autospectral.html">unmix.autospectral()</a></code>, AutoSpectral performs up to 100 such
calculations per cell per fluorophore. In other words, for that same set
of a million cells in 40 color space, as much as 100 x 40 x 1000000 =
4x10^9 times as many computationally intensive steps. The other reason
it’s slow is that I am not a computational person.</p>
<p>There are some things that can be done to improve this. Release
v1.0.0 will implement an approach to reduce the search space, somewhere
between 10 and 100x, which will help.</p>
<div class="section level2">
<h2 id="go-faster">Go Faster<a class="anchor" aria-label="anchor" href="#go-faster"></a>
</h2>
<p>R is not known for its speed.</p>
<p>For faster processing there are three things you can do, hopefully
all fairly easy.</p>
<p>First, upgrade the BLAS and LAPACK libraries used by R. These provide
algorithms for linear algebra, which is the heart of spectral
unmixing.</p>
<p>On Windows, simply swapping out your .dll files as in this tutorial
can give speed ups of 5x. <a href="https://github.com/david-cortes/R-openblas-in-windows" class="external-link">Install
OpenBLAS</a> All this involves is downloading the files from the
internet, placing them in the right folder and doing a quick
restart.</p>
<p>On Mac, you can use the vecLib library BLAS that ships with Mac OS as
this should be optimized for your system. The following articles may be
helpful in setting this as the default BLAS for use in R: <a href="https://cran.r-project.org/bin/macosx/RMacOSX-FAQ.html#Which-BLAS-is-used-and-how-can-it-be-changed_003f" class="external-link">BLAS
for Mac in R</a> <a href="https://csantill.github.io/RPerformanceWBLAS/" class="external-link">Performance
BLAS</a> Feedback from users on Mac who successfully upgrade their BLAS
would be appreciated.</p>
<p>Do not set multiple threads for the BLAS as this will conflict with
higher level parallelization, either in AutoSpectral or other
packages.</p>
<p>After upgrading the BLAS, you probably need to reinstall
<code>Rcpp</code> and <code>RcppArmadillo</code> to have this compiled
with the BLAS.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="st">"Rcpp"</span>, <span class="st">"RcppArmadillo"</span> <span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<p>Now, install AutoSpectralRcpp. This is fully accessible from R and
integrates with AutoSpectral. But, when it gets to the slow bits in the
unmixing, it switches over to calculating in C++, so it can be 10-100x
faster. Do this after upgrading the BLAS because the C++ gets compiled
with whatever BLAS you’ve got installed.</p>
<p><a href="https://github.com/DrCytometer/AutoSpectralRcpp" class="external-link">AutoSpectralRcpp</a></p>
<p>You will need <a href="https://cran.r-project.org/bin/windows/Rtools/" class="external-link">Rtools</a> to
compile this.</p>
<p>You can install AutoSpectralRcpp like so:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"DrCytometer/AutoSpectralRcpp"</span><span class="op">)</span></span></code></pre></div>
<p>Third, turn on parallel processing in AutoSpectral. <em>Update</em>:
This is now supported via a <code>parallel</code> backend. Importantly,
this moves away from <code>future</code> and <code>future_lapply</code>,
which were aborting sometimes on Windows. More usefully, this is a bit
faster in many cases, and should support forking via
<code>mclapply</code> on Mac and Linux systems, which will be much
faster. Perhaps most usefully, this appears to allow parallelization of
the native R per-cell fluorophore optimization in
<code>unmix.autospectral</code>, so you should see a nice speed up
there.</p>
<p>The parallel processing in AutoSpectralRcpp operates via OpenMP and
works well. It is always activated, but the number of threads can be
configured.</p>
<p>To activate parallel processing, check the function arguments for a
<code>parallel</code> option and set it to <code>TRUE</code>.
Additionally, there is control over the number of threads used, which
should be directly in the function call via a <code>threads</code>
argument. If you don’t know how many threads to use, check the
recommendation for your machine after running
<code><a href="../reference/get.autospectral.param.html">get.autospectral.param()</a></code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asp</span><span class="op">$</span><span class="va">max.worker.process.n</span></span></code></pre></div>
<p>Multithreading will always default to this number if you do not
explicitly set a number of threads and set <code>parallel=TRUE</code>.
This is one less than <code><a href="https://parallelly.futureverse.org/reference/availableCores.html" class="external-link">parallelly::availableCores()</a></code>, so it
is designed to allow you to keep working on minor stuff while
AutoSpectral chugs along in the background.</p>
<p>Or just check how many you have available:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">parallelly</span><span class="fu">::</span><span class="fu"><a href="https://parallelly.futureverse.org/reference/availableCores.html" class="external-link">availableCores</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>For unmixing larger data sets, you will do well to use a machine with
more CPUs. Version 1.0.0 brings faster processing for the unmixing.</p>
</div>
<div class="section level2">
<h2 id="installation-and-runtime">Installation and Runtime<a class="anchor" aria-label="anchor" href="#installation-and-runtime"></a>
</h2>
<p>Installation via GitHub should take only a minute or so. It takes
less than that on my Dell i7 core laptop, but that may also be because I
have already installed the dependencies.</p>
<p>Occasionally, the help gets corrupted. Just re-install if that
happens. If you know why this happens, let me know.</p>
<p>Installation of <code>AutoSpectralRcpp</code> will take a couple of
minutes because the code needs to compile. You will also first have to
install Rtools to have a compiler, and that will take longer, probably
10 minutes or so. Upgrading the BLAS and LAPACK (see below) also takes
several minutes if you’re taking the time to read the instructions
carefully.</p>
<p>Run-time will vary considerably depending on the size and quantity of
files you’re processing. For the benchmark 42-color Aurora dataset using
single-stained cell controls with plenty of data, the slow steps in the
pre-processing pipeline are <code><a href="../reference/define.flow.control.html">define.flow.control()</a></code> and
<code><a href="../reference/clean.controls.html">clean.controls()</a></code>. For the same Aurora dataset on the
aforementioned i7 Windows laptop, I get:</p>
<ul>
<li>
<code><a href="../reference/define.flow.control.html">define.flow.control()</a></code> v0.8.7: 12min sequential, 9min
parallel</li>
<li>
<code><a href="../reference/define.flow.control.html">define.flow.control()</a></code> v0.9.0: 4min sequential, 2min
parallel</li>
<li>
<code><a href="../reference/clean.controls.html">clean.controls()</a></code> v0.8.7: 11min sequential, not possible
parallel</li>
<li>
<code><a href="../reference/clean.controls.html">clean.controls()</a></code> v0.9.0: 11min sequential, 6.5min
parallel, not fully optimized</li>
<li>
<code><a href="../reference/get.spectral.variants.html">get.spectral.variants()</a></code> v.0.8.7: 2min sequential, 1min
parallel</li>
<li>
<code><a href="../reference/get.spectral.variants.html">get.spectral.variants()</a></code> v.0.9.0: 65sec sequential,
32sec parallel</li>
</ul>
<p>These should run faster in v1.0.0 for datasets with lots of cells
because I have changed the default plotting settings to limit the
maximum number of events plotted (plotting lots of points is slow in R,
even with the accelerated <code>scattermore</code> package).</p>
<p>Unmixing time depends on the following variable:</p>
<ul>
<li>file size (number of cells/events, including debris)</li>
<li>number of detectors (ID7000 data takes a bit longer)</li>
<li>number of fluorophores</li>
<li>unmixing algorithm</li>
</ul>
<p>OLS and WLS are fast, per-cell AF extraction will be slower, per-cell
fluorophore optimization will be slower still. As of version 1.0.0, the
time required is down quite a bit (see below).</p>
<p>If you are not using <code>AutoSpectralRcpp</code>, then the per-cell
methods will likely run about 10x slower.</p>
<p>Benchmarks for “C3 Lung_GFP_003_Samples.fcs”, again on the 8-core
laptop, using OpenBLAS and AutoSpectralRcpp, where applicable:</p>
<ul>
<li>
<code><a href="../reference/unmix.fcs.html">unmix.fcs()</a></code> WLS or OLS v0.8.7: 9sec</li>
<li>
<code><a href="../reference/unmix.fcs.html">unmix.fcs()</a></code> WLS or OLS v0.9.0: 9sec</li>
<li>
<code><a href="../reference/unmix.fcs.html">unmix.fcs()</a></code> WLS or OLS v1.0.0: 9-10sec (most of this is
handling the FCS file)</li>
<li>
<code><a href="../reference/unmix.fcs.html">unmix.fcs()</a></code> perCell AF extraction v0.8.7: 2min</li>
<li>
<code><a href="../reference/unmix.fcs.html">unmix.fcs()</a></code> perCell AF extraction v0.9.0: 1min</li>
<li>
<code><a href="../reference/unmix.fcs.html">unmix.fcs()</a></code> perCell AF extraction v1.0.0: 14sec (45s in
R without C++)</li>
<li>
<code><a href="../reference/unmix.fcs.html">unmix.fcs()</a></code> perCell fluorophore optimization “fast”
v0.8.7: 9min</li>
<li>
<code><a href="../reference/unmix.fcs.html">unmix.fcs()</a></code> perCell fluorophore optimization “fast”
v0.9.0: &lt;2min</li>
<li>
<code><a href="../reference/unmix.fcs.html">unmix.fcs()</a></code> perCell fluorophore optimization “fast”
v1.0.0: &lt;2min (note: performance here should now be comparable to the
previous “slow”)</li>
<li>
<code><a href="../reference/unmix.fcs.html">unmix.fcs()</a></code> perCell fluorophore optimization “slow”
v0.8.7: 62min</li>
<li>
<code><a href="../reference/unmix.fcs.html">unmix.fcs()</a></code> perCell fluorophore optimization “slow”
v0.9.0: 19min</li>
<li>
<code><a href="../reference/unmix.fcs.html">unmix.fcs()</a></code> perCell fluorophore optimization “slow”
v1.0.0: 11min</li>
<li>
<code><a href="../reference/unmix.folder.html">unmix.folder()</a></code> WLS or OLS, 6 files, v0.8.7: 67sec
sequential, interrupted parallel</li>
<li>
<code><a href="../reference/unmix.folder.html">unmix.folder()</a></code> WLS or OLS, 6 files, v0.9.0: 62sec
sequential, 31sec parallel</li>
</ul>
<p>I do not expect more major gains, although I will look into GPU
acceleration.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Oliver Burton, Adrian Liston.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
