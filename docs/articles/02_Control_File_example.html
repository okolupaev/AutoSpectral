<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>02 Creating the control file • AutoSpectral</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="02 Creating the control file">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">AutoSpectral</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/01_Full_AutoSpectral_Workflow.html">01 Full Workflow Example</a></li>
    <li><a class="dropdown-item" href="../articles/02_Control_File_example.html">02 Creating the control file</a></li>
    <li><a class="dropdown-item" href="../articles/03_Aurora_example.html">03 Aurora AutoSpectral Example</a></li>
    <li><a class="dropdown-item" href="../articles/04_ID7000_WLS_example.html">04 ID7000 WLS Example</a></li>
    <li><a class="dropdown-item" href="../articles/05_Preparing_Controls.html">05 Preparing Controls</a></li>
    <li><a class="dropdown-item" href="../articles/06_Gating.html">06 Gating</a></li>
    <li><a class="dropdown-item" href="../articles/07_Cleaning.html">07 Control clean-up</a></li>
    <li><a class="dropdown-item" href="../articles/08_Single_Cell_AutoFluorescence.html">08 Single Cell Autofluorescence</a></li>
    <li><a class="dropdown-item" href="../articles/09_Per_Cell_Optimization.html">09 Per Cell Optimization</a></li>
    <li><a class="dropdown-item" href="../articles/10_Reload_AutoSpectral.html">10 Re-running AutoSpectral</a></li>
    <li><a class="dropdown-item" href="../articles/11_Plotting.html">11 Plotting</a></li>
    <li><a class="dropdown-item" href="../articles/12_Speed_It_Up.html">12 Speed It Up (Why So Slow?)</a></li>
    <li><a class="dropdown-item" href="../articles/13_Updates_And_Issues.html">13 Updates and Issues</a></li>
    <li><a class="dropdown-item" href="../articles/14_Development.html">14 Development</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/DrCytometer/AutoSpectral/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>02 Creating the control file</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DrCytometer/AutoSpectral/blob/HEAD/vignettes/articles/02_Control_File_example.Rmd" class="external-link"><code>vignettes/articles/02_Control_File_example.Rmd</code></a></small>
      <div class="d-none name"><code>02_Control_File_example.Rmd</code></div>
    </div>

    
    
<p><em>Update</em>: there is now a Shiny app you can use to create your
control file. You may find this to be easier as it provides an
interactive interface much like a webpage. To use the app, download it
from <a href="https://github.com/DrCytometer/AutoSpectralHelper" class="external-link">AutoSpectral
App</a> and place a copy of the <code>app.r</code> file in the folder
you’re working in. For easiest use, place the app file one level up from
the folder containing the single-stained control files, for example:
<img src="figures/app_location.jpg" alt="App location"></p>
<p>In this article, we’re going to cover how to create a control file,
which is an essential first step in running AutoSpectral. The control
file is a specifically formatted spreadsheet describing your
single-stained control files. In the original AutoSpill, this needed to
be created manually, but in AutoSpectral there is an option to fill in a
lot of the information automatically. Let’s see how this works.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DrCytometer/AutoSpectral" class="external-link">AutoSpectral</a></span><span class="op">)</span></span></code></pre></div>
<p>To start, we need to get the relevant parameters for the cytometer.
This tells AutoSpectral a lot about what you’re doing. In this example,
we’ll use data from the Cytek Aurora. These are the same data as in the
Aurora_example article. <a href="https://data.mendeley.com/datasets/xzt3h3gnx9/1" class="external-link uri">https://data.mendeley.com/datasets/xzt3h3gnx9/1</a></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.autospectral.param.html">get.autospectral.param</a></span><span class="op">(</span>cytometer <span class="op">=</span> <span class="st">"aurora"</span><span class="op">)</span></span></code></pre></div>
<p>Create a folder containing only the single-stained control FCS files
describe the path to that folder here.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">control.dir</span> <span class="op">&lt;-</span> <span class="st">"~/AutoSpectral_data/Aurora_example/Aurora_controls"</span></span></code></pre></div>
<p>With this information, we can create a draft of the control file.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/create.control.file.html">create.control.file</a></span><span class="op">(</span><span class="va">control.dir</span>, <span class="va">asp</span><span class="op">)</span></span></code></pre></div>
<p>What this does is create a CSV file that in our case looks like this:
<img src="figures/initial_control_file.jpg" alt="Control file example"></p>
<p>We get a list of all the fcs files in the folder
<code>control.dir</code>. These are in the <code>filename</code> column.
If you don’t see anything here, you’ve probably typed the path
incorrectly, but most likely in that case you’ll also get an error.</p>
<p>The next column is <code>fluorophore</code>. AutoSpectral has a
database (or in other words, a spreadsheet) of fluorophores and several
common synonyms for each. It’ll try to figure out the name of the
fluorophore in each of your single-stained controls and add this in the
corresponding <code>fluorophore</code> column. If you’re using a new
fluorophore that isn’t in the database, or you’ve called it something
odd like “Paficic blu3”, you’ll get <code>No Match</code> in the
fluorophore column. We’ll look at an example of this next. Any
<code>No Match</code> values must be changed–these are an indication
that you need to do the work yourself.</p>
<p>If you want, you can change the name of the fluorophore. Importantly,
the names in the <code>fluorophore</code> column is what will appear not
only any plots but also in the parameter names of the unmixed FCS
files.</p>
<p>After <code>fluorophore</code>, we have <code>channel</code>. This is
the “peak” channel for the fluorophore. If the fluorophore has been
found in the database, you should see something in the
<code>channel</code> column (and this should look appropriate for your
cytometer). If not, add the peak channel, which you can look up on
spectral viewer tools such as FluoroFinder, Cytek Cloud or BD Research
Cloud.</p>
<p>This channel does not actually need to be the peak channel for the
fluorophore, but it must be a channel that receives a good amount of
signal and provides separation from the negative population. Notice that
the <code>Unstained</code> sample does not get a channel assignment.
That’s fine. The <code>Unstained</code> cell sample will automatically
be used to generate a median autofluorescence signature, as you might
get with single-parameter autofluorescence extraction on most
cytometers. Don’t change the name of the <code>Unstained</code> cell
sample–leave it as <code>AF</code>.</p>
<p>Next, we have <code>control.type</code>. This is important to get
right. For Aurora samples, as part of a Reference Group, you
automatically get <code>Cells</code> or <code>Beads</code> as part of
the file name, and AutoSpectral will parse this, as it has done here.
For other platforms, you’ll need to enter the type of control for each
single-stained control. Beads and cells are treated a bit differently
for gating and autofluorecence handling, so you’ll get problems if you
put in the wrong type. Please stick to lower case, using either
<code>cells</code> or <code>beads</code>.</p>
<p>The final three columns will always need to be filled in manually.
For best results, you generally want to use a universal negative. In the
<code>universal.negative</code> column, copy and paste name of the
matching unstained sample from the <code>filename</code> column: <img src="figures/universal_negative_control_file.jpg" alt="Universal negative file example"></p>
<p>In this case, we only have one unstained sample because all the
controls are from the same source: human PBMC.</p>
<p>The <code>large.gate</code> column provides a degree of control over
the automated gating. We’ll cover gating more extensively in another
article because that’s pretty complex, to be honest. What you need to
know here is whether your cells are small or big, basically. The default
gating is going to draw a rounded gate around the first dense population
to the right of the debris: <img src="figures/cells_nonViability_largeGate.jpg" alt="Cell gating plot"></p>
<p>Here you can see that we’re mapping the density of events on FSC and
SSC. By default, the first population (1) is skipped, under the
assumption that this will normally be debris and/or dead cells. This can
be modified, see the gating article for details. Population 2 will be
the default target (square box), which works well in mouse and human
immunology where lymphocytes predominate. If your marker is expressed
primarily or at its highest level on cells that are bigger or more
granular, you need to set <code>large.gate</code> to <code>TRUE</code>.
This will then expand the gate as seen in the plot above with the curved
rectangular gate.</p>
<p>In the control file spreadsheet, we’re going to set
<code>large.gate</code> to <code>TRUE</code> for markers we know to be
on cells bigger than T cells. If you don’t know, you can open your
controls in a tool such as FlowJo or FCSExpress and plot the peak
channel for your marker versus SSC (or check on some unmixed data).</p>
<p>Setting Large Gate options: <img src="figures/large_gate_control_file.jpg" alt="Large gate example"></p>
<p>Note that CD56 cells, particularly the CD56-bright cells, tend to be
a bit higher on SSC than the T lymphocytes.</p>
<p>CD8 T cell gating: <img src="figures/SparkUV387.jpg" alt="CD8 lymphocyte gating plot"></p>
<p>CD14 monocyte gating: <img src="figures/BV510.jpg" alt="CD14 monocyte gating plot"></p>
<p>Finally, we get to the <code>is.viability</code> column. This dataset
doesn’t have a viability dye (ooh, not good!). This means we don’t put
anything in this column. If we had a viability dye, we would put
<code>TRUE</code> in the <code>is.viability</code> column for that
control. This affects the gating, extending the gate to the left on FSC
to include more dead cells, as we can see in this example of mostly dead
mouse splenocytes:</p>
<div class="float">
<img src="figures/cells_viabilityMarker_smallGate.jpg" alt="Viability gate example"><div class="figcaption">Viability gate example</div>
</div>
<p>Whatever you’ve named your control file (the default output is
<code>fcs_control_file.csv</code>), you’ll need to tell AutoSpectral
what it’s called:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">control.file</span> <span class="op">&lt;-</span> <span class="st">"fcs_control_file.csv"</span></span></code></pre></div>
<p>To confirm that everything is set up correctly, and to check for a
multitude of other potential problems, AutoSpectral contains this handy
helper function called <code>check.control.file</code>. This actually
checks your single-stained control FCS files as well to be sure that
they’re all consistent with each other. This outputs the list of
critical errors (things that will probably stop AutoSpectral from
running) and warnings (things to check–did you mean to set it up that
way?) as a message to the screen and also returns it as an object. So,
if there are a lot of errors, you can review the list again. Note that
<code>check.control.file</code> runs inside of
<code>define.flow.control</code> with a strict setting that will cause
it to abort if it finds anything it deems to be an error. So, fix the
errors first.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">potential.problems</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/check.control.file.html">check.control.file</a></span><span class="op">(</span><span class="va">control.dir</span>, <span class="va">control.file</span>, <span class="va">asp</span><span class="op">)</span></span></code></pre></div>
<p>For this dataset, the control file is now complete and we are ready
to run AutoSpectral.</p>
<p>If you happen to run <code>create.control.file</code> again, it will
create another blank control file spreadsheet with an incrementing file
number. This ensures that it doesn’t overwrite your existing filled-in
control file.</p>
<p><em>Haven’t done this yet, sorry</em> In the next article, we’ll look
at how to create a control file for a more complex experiment where we
have beads and cells, different universal negatives and, ideally, a
viability marker. We’ll also see what to do when your fluorophores can’t
be found in the database.</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Oliver Burton, Adrian Liston.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
