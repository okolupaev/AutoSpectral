<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>08 Single Cell Autofluorescence • AutoSpectral</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="08 Single Cell Autofluorescence">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">AutoSpectral</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/01_Full_AutoSpectral_Workflow.html">01 Full Workflow Example</a></li>
    <li><a class="dropdown-item" href="../articles/02_Control_File_example.html">02 Creating the control file</a></li>
    <li><a class="dropdown-item" href="../articles/03_Aurora_example.html">03 Aurora AutoSpectral Example</a></li>
    <li><a class="dropdown-item" href="../articles/04_ID7000_WLS_example.html">04 ID7000 WLS Example</a></li>
    <li><a class="dropdown-item" href="../articles/05_Preparing_Controls.html">05 Preparing Controls</a></li>
    <li><a class="dropdown-item" href="../articles/06_Gating.html">06 Gating</a></li>
    <li><a class="dropdown-item" href="../articles/07_Cleaning.html">07 Control clean-up</a></li>
    <li><a class="dropdown-item" href="../articles/08_Single_Cell_AutoFluorescence.html">08 Single Cell Autofluorescence</a></li>
    <li><a class="dropdown-item" href="../articles/09_Per_Cell_Optimization.html">09 Per Cell Optimization</a></li>
    <li><a class="dropdown-item" href="../articles/10_Reload_AutoSpectral.html">10 Re-running AutoSpectral</a></li>
    <li><a class="dropdown-item" href="../articles/11_Plotting.html">11 Plotting</a></li>
    <li><a class="dropdown-item" href="../articles/12_Speed_It_Up.html">12 Speed It Up (Why So Slow?)</a></li>
    <li><a class="dropdown-item" href="../articles/13_Updates_And_Issues.html">13 Updates and Issues</a></li>
    <li><a class="dropdown-item" href="../articles/14_Development.html">14 Development</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/DrCytometer/AutoSpectral/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>08 Single Cell Autofluorescence</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DrCytometer/AutoSpectral/blob/HEAD/vignettes/articles/08_Single_Cell_AutoFluorescence.Rmd" class="external-link"><code>vignettes/articles/08_Single_Cell_AutoFluorescence.Rmd</code></a></small>
      <div class="d-none name"><code>08_Single_Cell_AutoFluorescence.Rmd</code></div>
    </div>

    
    
<p>The aim of this article is to show you how to use AutoSpectral’s
per-cell autofluorescence (AF) extraction. This method selects the best
AF signature to use for each cell (or point of debris, noise, whatever)
in the data.</p>
<p>The first thing we need to do is discover all of the AF signatures
present in the data. For this, the unstained control is critical. For
good results, you need to do the following in your wet lab work: * 1)
Prepare a truly unstained sample. This means no added fluorophores, so
no conjugated antibodies or live/dead stains and no fluorescent buffers
such as the Brilliant Stain buffer. This also means no fluorescent
reporters. If you run GFP expressing cells as your unstained, the GFP
signal in those will be considered an AF signature, and it will be
unmixed as autofluorescence rather than GFP. If you contaminate your
unstained with small amounts of stained cells, single-stained controls
or fluorescent beads, those signatures may also be considered to be AF.
* 2) Treat your unstained sample like your fully stained sample. Run it
through the same protocol. If you’re fixing and permeabilizing, do that
to the unstained, too. * 3) Acquire lots of cells. If you only acquire
10 thousand events, you will have very little data to work with, and
rare populations, which are probably the problematic ones, will not show
up well. Ideally, run as many cells as in your fully stained samples. *
4) Run unstained samples for each sample type in your data if you expect
a difference in AF For example, with tissue samples, run a sample from
spleen, lymph nodes and lung, not just spleen or lung. If you’re running
samples from drastically different conditions (e.g., infected
vs. healthy or infant vs. adult), I suggest running an unstained for
each. * 5) For smaller differences in conditions, you will probably get
good results by creating a pooled unstained sample. For instance, when
running PBMC from multiple donors, you could take a few cells from each
for the unstained sample for AF.</p>
<p>You’re welcome to play around with breaking these rules to see what
happens.</p>
<p>A note about pooling: This can be done in the wet lab by mixing the
cells into a single tube. A safer, and likely more representative option
is to mix in silico after acquisition. This can be done by concatenating
the FCS files or by using a function such as
<code>AggregateFlowFrame()</code> from <code>FlowSOM</code>. I really,
really do not recommend concatenating with FlowJo v10 (and have not
tested v11). Also, <code>premessa</code> also does not produce FCS files
with all the information intact, so avoid that.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span> <span class="va"><a href="https://github.com/DrCytometer/AutoSpectral" class="external-link">AutoSpectral</a></span> <span class="op">)</span></span></code></pre></div>
<p>Before doing the single-cell AF extraction, you’ll need to either run
the AutoSpectral workflow to extract your fluorescence spectra or
extract the spectra using another method (e.g., FlowJo or from the Cytek
.Expt file). This is because we will use these spectra in the
determination of the AF spectra. We’re going to be looking at both the
raw and unmixed versions of the unstained sample in order to determine
how the AF signatures present are likely to interfere with the
unmixing.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.autospectral.param.html">get.autospectral.param</a></span><span class="op">(</span> cytometer <span class="op">=</span> <span class="st">"aurora"</span>, figures <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span></span>
<span><span class="va">control.dir</span> <span class="op">&lt;-</span> <span class="st">"./SSC"</span></span>
<span><span class="va">control.file</span> <span class="op">&lt;-</span> <span class="st">"fcs_control_file.csv"</span></span>
<span><span class="va">flow.control</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define.flow.control.html">define.flow.control</a></span><span class="op">(</span> <span class="va">control.dir</span>, <span class="va">control.file</span>, <span class="va">asp</span> <span class="op">)</span></span>
<span><span class="va">flow.control</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clean.controls.html">clean.controls</a></span><span class="op">(</span> <span class="va">flow.control</span>, <span class="va">asp</span> <span class="op">)</span></span>
<span><span class="va">spectra</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.fluorophore.spectra.html">get.fluorophore.spectra</a></span><span class="op">(</span> <span class="va">flow.control</span>, <span class="va">asp</span>, use.clean.expr <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                                    title <span class="op">=</span> <span class="st">"Clean Spectra"</span> <span class="op">)</span></span></code></pre></div>
<p>Now we are ready to get the AF spectra. For this data set, we have
spleen, lung and brain samples from mouse. We can do all three. I’ve got
the files in the <code>./SSC</code> folder, but be sure to pass the file
path as well as the file name to the first argument of
<code>get.af.spectra</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">unstained.lung</span> <span class="op">&lt;-</span> <span class="st">"G2 WT Lung_Samples.fcs"</span></span>
<span><span class="va">unstained.brain</span> <span class="op">&lt;-</span> <span class="st">"G3 WT Brain_Samples.fcs"</span></span>
<span><span class="va">unstained.spleen</span> <span class="op">&lt;-</span> <span class="st">"G1 WT Spleen_Samples.fcs"</span></span>
<span></span>
<span><span class="va">lung.af</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.af.spectra.html">get.af.spectra</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span> <span class="va">control.dir</span>, <span class="va">unstained.lung</span> <span class="op">)</span>,</span>
<span>                           <span class="va">asp</span>, <span class="va">spectra</span>, title <span class="op">=</span> <span class="st">"Lung AF"</span> <span class="op">)</span></span>
<span><span class="va">brain.af</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.af.spectra.html">get.af.spectra</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span> <span class="va">control.dir</span>, <span class="va">unstained.brain</span> <span class="op">)</span>, </span>
<span>                            <span class="va">asp</span>, <span class="va">spectra</span>, title <span class="op">=</span> <span class="st">"Brain AF"</span> <span class="op">)</span></span>
<span><span class="va">spleen.af</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.af.spectra.html">get.af.spectra</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span> <span class="va">control.dir</span>, <span class="va">unstained.spleen</span> <span class="op">)</span>, </span>
<span>                             <span class="va">asp</span>, <span class="va">spectra</span>, title <span class="op">=</span> <span class="st">"Spleen AF"</span> <span class="op">)</span></span></code></pre></div>
<p>This call reads the FCS file, unmixes it, and creates a
self-organizing map (SOM) of the combined raw and unmixed data. Each SOM
node (<code>map$code</code>) is considered an AF signature. Note that
you can increase or decrease the number of spectra generated by changing
the SOM dimensions with argument <code>som.dim</code>. The default
<code>10</code> generates 100 spectra (10 x 10), which works quite well.
It’s likely overkill for simple AF mixtures like PBMCs, but it does not
hurt except for taking longer during the unmixing. If you have really
messy samples, you could play around with larger SOMs, but the default
settings work well for mouse lung, which is pretty terrible for AF.</p>
<p>We get output plots of the AF signatures in the
<code>figure_autofluorescence</code> folder.</p>
<p><img src="figures/Lung_AF_20250909.jpg" alt="Lung AF"><img src="figures/Brain_AF_20250909.jpg" alt="Lung AF"><img src="figures/Spleen_AF_20250909.jpg" alt="Lung AF"></p>
<p>From the variability, I think you can start to understand why it’s
really hard to get good results with single or multiple AF extraction
using the standard method.</p>
<p>There’s also a heatmap generated, but I don’t find this so useful. If
you want, you can probably create some nicer looking plots with some
metaclustering or a dendrogram to group the AF signatures. We don’t use
metaclustering on the SOM nodes because this gives slightly inferior
results in the unmixing.</p>
<div class="float">
<img src="figures/Lung_AF_spectral_heatmap.jpg" alt="Lung AF heatmap"><div class="figcaption">Lung AF heatmap</div>
</div>
<p>Okay, now we’re ready to unmix with per-cell AF extraction.</p>
<p>If you are working with multiple sources like in this example, be
sure to provide the corresponding AF for the unmixing. For example, for
lung cells, provide the lung AF spectra. If you provide a non-matching
AF, it won’t create problems (based on both theory and empirical
testing), but the results will not be as good as if a matching one were
used, simply because the best match won’t be present for all cells. Note
that this means you can use pooled samples as long as you have enough
events acquired, although you may need to increase <code>som.dim</code>
if there are a lot of AF signatures present in each part of the
pool.</p>
<div class="section level2">
<h2 id="update-for-version-1-0-0">Update for Version 1.0.0<a class="anchor" aria-label="anchor" href="#update-for-version-1-0-0"></a>
</h2>
<p>Version 1.0.0 changes the way autofluorescence spectra are identified
slightly, allowing for a second round of identification of cells that
are likely to be problematic given only the first set of AF spectra.
This is done by using AutoSpectral’ per-cell autofluorescence extraction
on the unstained sample. Any signal in the fluorophore channels in the
unmixed unstained data can be considered to be error. In the update, we
select the cells that are the furthest from zero in the unmixed space
and run a second round of cluster on these, updating the AF spectra that
were used to unmix them. This expands the set of possibilities, focusing
on the worst offenders. This is most useful for complex tissue samples,
and allows extraction of the problematic last 1-3% of cells that are in
the wrong place.</p>
</div>
<div class="section level2">
<h2 id="extracting-af-for-each-cell">Extracting AF for each cell<a class="anchor" aria-label="anchor" href="#extracting-af-for-each-cell"></a>
</h2>
<p>While you can call <code><a href="../reference/unmix.autospectral.html">unmix.autospectral()</a></code> directly, this
requires reading in the FCS file into R, extracting the expression data
and so on. The better option is to just call unmix.fcs directly, which
will create an unmixed FCS file from your raw FCS file.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fully.stained.dir</span> <span class="op">&lt;-</span> <span class="st">"./Fully stained"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/unmix.fcs.html">unmix.fcs</a></span><span class="op">(</span> fcs.file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span> <span class="va">fully.stained.dir</span>, <span class="st">"C3 Lung_GFP_003_Samples.fcs"</span> <span class="op">)</span>,</span>
<span>           spectra <span class="op">=</span> <span class="va">spectra</span>,</span>
<span>           asp <span class="op">=</span> <span class="va">asp</span>,</span>
<span>           flow.control <span class="op">=</span> <span class="va">flow.control</span>,</span>
<span>           method <span class="op">=</span> <span class="st">"AutoSpectral"</span>,</span>
<span>           af.spectra <span class="op">=</span> <span class="va">lung.af</span> <span class="op">)</span></span></code></pre></div>
<p>This will use OLS to find the optimal AF per cell. To use WLS, set
<code>weighted = TRUE</code>.</p>
<p>Alternatively, we can call <code>method = "Automatic"</code>, which
is the default. This takes care of the decision making for AF extraction
and weighting automatically. So, if you provide <code>af.spectra</code>,
per-cell AF extraction will be done. Weighting will be used if the data
come from the ID7000, the FACSDiscoverS8 or the FACSDiscoverA8,
attempting to replicate the methodology used on those systems. For
explicit control, call <code>method = "AutoSpectral"</code> as above,
and set the arguments.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/unmix.fcs.html">unmix.fcs</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span> <span class="va">fully.stained.dir</span>, <span class="st">"C3 Lung_GFP_003_Samples.fcs"</span> <span class="op">)</span>,</span>
<span>           <span class="va">spectra</span>,</span>
<span>           <span class="va">asp</span>,</span>
<span>           <span class="va">flow.control</span>,</span>
<span>           af.spectra <span class="op">=</span> <span class="va">lung.af</span> <span class="op">)</span></span></code></pre></div>
<p>Unmixed FCS files will appear in folder
<code>./autospectral_unmixed</code>.</p>
<div class="section level3">
<h3 id="go-faster">Go Faster<a class="anchor" aria-label="anchor" href="#go-faster"></a>
</h3>
<p>Per-cell AF extraction involves unmixing the data once per AF
signature provided. Since this is a lot of linear algebra, using an
optimized library for linear algebra speeds this process up a lot. We
suggest swapping out the default R BLAS and LAPACK dll files for the
optimized versions in OpenBLAS (or other even better versions). This is
relatively simple to do: <a href="https://github.com/david-cortes/R-openblas-in-windows" class="external-link uri">https://github.com/david-cortes/R-openblas-in-windows</a>
Expect speed ups of ~5x.</p>
<p>Don’t set multiple threads for the BLAS. That will interfere with the
parallel processing used in other parts of AutoSpectral and probably
other R packages.</p>
<p>Additionally, as of version 1.0.0, the process of assigning AF
signatures to individual cells (and then unmixing them) has been sped up
in C++. For this, you will need to install
<code>AutoSpectralRcpp</code>.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Oliver Burton, Adrian Liston.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
