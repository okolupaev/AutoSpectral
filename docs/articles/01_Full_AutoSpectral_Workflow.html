<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>01 Full Workflow Example • AutoSpectral</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="01 Full Workflow Example">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">AutoSpectral</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/01_Full_AutoSpectral_Workflow.html">01 Full Workflow Example</a></li>
    <li><a class="dropdown-item" href="../articles/02_Control_File_example.html">02 Creating the control file</a></li>
    <li><a class="dropdown-item" href="../articles/03_Aurora_example.html">03 Aurora AutoSpectral Example</a></li>
    <li><a class="dropdown-item" href="../articles/04_ID7000_WLS_example.html">04 ID7000 WLS Example</a></li>
    <li><a class="dropdown-item" href="../articles/05_Preparing_Controls.html">05 Preparing Controls</a></li>
    <li><a class="dropdown-item" href="../articles/06_Gating.html">06 Gating</a></li>
    <li><a class="dropdown-item" href="../articles/07_Cleaning.html">07 Control clean-up</a></li>
    <li><a class="dropdown-item" href="../articles/08_Single_Cell_AutoFluorescence.html">08 Single Cell Autofluorescence</a></li>
    <li><a class="dropdown-item" href="../articles/09_Per_Cell_Optimization.html">09 Per Cell Optimization</a></li>
    <li><a class="dropdown-item" href="../articles/10_Reload_AutoSpectral.html">10 Re-running AutoSpectral</a></li>
    <li><a class="dropdown-item" href="../articles/11_Plotting.html">11 Plotting</a></li>
    <li><a class="dropdown-item" href="../articles/12_Speed_It_Up.html">12 Speed It Up (Why So Slow?)</a></li>
    <li><a class="dropdown-item" href="../articles/13_Updates_And_Issues.html">13 Updates and Issues</a></li>
    <li><a class="dropdown-item" href="../articles/14_Development.html">14 Development</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/DrCytometer/AutoSpectral/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>01 Full Workflow Example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DrCytometer/AutoSpectral/blob/HEAD/vignettes/articles/01_Full_AutoSpectral_Workflow.Rmd" class="external-link"><code>vignettes/articles/01_Full_AutoSpectral_Workflow.Rmd</code></a></small>
      <div class="d-none name"><code>01_Full_AutoSpectral_Workflow.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>If you need to install AutoSpectral, run this bit first:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install Bioconductor packages</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"BiocManager"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"BiocManager"</span><span class="op">)</span></span>
<span><span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://bioconductor.github.io/BiocManager/reference/install.html" class="external-link">install</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"flowWorkspace"</span>, <span class="st">"flowCore"</span>, <span class="st">"PeacoQC"</span>, <span class="st">"FlowSOM"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># You'll need devtools or remotes to install from GitHub.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"DrCytometer/AutoSpectral"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="get-the-data">Get the data<a class="anchor" aria-label="anchor" href="#get-the-data"></a>
</h2>
<p>Download the data for today’s example from <a href="https://data.mendeley.com/datasets/ch5dnspd79/1" class="external-link">Mendeley
Data</a>.</p>
<p>These data are a 9-colour panel run on a 5-laser Cytek Aurora. The
samples are from spleen, lung and liver. This is a pretty simple
experiment, which is nice since it will run quickly. The different
tissues allow us to look at how to handle diverse autofluorescence
profiles. I’ll point out that this panel has been deliberately designed
to accommodate autofluorescence peaks, so we can expect autofluorescence
removal to work pretty well with any method. In my testing, you can use
multiple autofluorescences and get good results; you can also use
deconvolution of the autofluorescence using principal components. Both
produce good results with a highly over-determined data set like this.
We’ll look at the per-cell autofluorescence extraction with these data,
which has the advantage of also working on large panels.</p>
</div>
<div class="section level2">
<h2 id="start-up">Start-up<a class="anchor" aria-label="anchor" href="#start-up"></a>
</h2>
<p>Now we can load AutoSpectral.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DrCytometer/AutoSpectral" class="external-link">AutoSpectral</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="getting-your-fluorophore-spectra-from-the-controls">Getting your fluorophore spectra from the controls<a class="anchor" aria-label="anchor" href="#getting-your-fluorophore-spectra-from-the-controls"></a>
</h2>
<p>Since the default cytometer is the Aurora, we can actually just call
this without any arguments. Otherwise you need to specify the cytometer
you’re using.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.autospectral.param.html">get.autospectral.param</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Where are the controls? This must be typed correctly.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">control.dir</span> <span class="op">&lt;-</span> <span class="st">"./Raw/Set1/Reference Group"</span></span></code></pre></div>
<p>Create the control file. You will need to manually edit your control
file, telling AutoSpectral what’s going on. It will try to fill in some
stuff for you, but you should check this. See the article on this on <a href="https://drcytometer.github.io/AutoSpectral/articles/02_Control_File_example.html">GitHub</a>
or <a href="https://www.colibri-cytometry.com/post/autospectral-creating-the-control-file" class="external-link">Colibri
Cytometry</a>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/create.control.file.html">create.control.file</a></span><span class="op">(</span><span class="va">control.dir</span>, <span class="va">asp</span><span class="op">)</span></span></code></pre></div>
<p>We get warnings because I’ve got both bead and cell controls, and
AutoSpectral would like me to pick one per fluorophore. This isn’t
strictly necessary, so if you want to bypass this, just change the names
in the “fluorophore” column of the control file to be unique names. For
instance, you could have “PE cells” and “PE beads”. Note, however, that
whatever you put as the “fluorophore” is what gets written to the
description of the channel in the FCS file later on. So, you’ll be
better off picking one control per fluorophore. If you have a situation
like this, you can run the controls in different
<code>flow.control</code> sets, figure out which you like best, and then
do a final version with the best choices.</p>
<p>Here’s what the control file looks like as first generated: <img src="figures/Workflow/initial_control_file.jpg" alt="Initial Control File"></p>
<p>Here’s what we want it to look like: <img src="figures/Workflow/final_control_file.jpg" alt="Final Control File"></p>
<p>For more on this, see the Control File article on GitHub.</p>
<p>Once you’ve got it the way you want, write in the name of the control
file and run the error checking function.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">control.file</span> <span class="op">&lt;-</span> <span class="st">"fcs_control_file.csv"</span></span>
<span><span class="fu"><a href="../reference/check.control.file.html">check.control.file</a></span><span class="op">(</span><span class="va">control.dir</span>, <span class="va">control.file</span>, <span class="va">asp</span><span class="op">)</span></span></code></pre></div>
<p>Once, the control file passes the error checks, we can load in the
data. This part can be a bit slow, particularly if you have lots of big
files. There is a parallelization option, which can cut the time in
half, probably even better on Mac/Linux. There are some improvements I
could make to this, including the gating. These will take time to
implement, though, because they affect everything downstream of this,
which is to say, everything.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flow.control</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define.flow.control.html">define.flow.control</a></span><span class="op">(</span><span class="va">control.dir</span>, <span class="va">control.file</span>, <span class="va">asp</span><span class="op">)</span></span></code></pre></div>
<p>Be sure to check the gates that are generated in the
<code>figure_gate</code> folder–do they look right? If not, go to the
Gating article on <a href="https://drcytometer.github.io/AutoSpectral/articles/04_Gating.html">GitHub</a>
<a href="https://www.colibri-cytometry.com/post/autospectral-gating" class="external-link">Colibri</a>
for tips on how fix it.</p>
<div class="float">
<img src="figures/Workflow/cell_gate.jpg" alt="Cell Gate"><div class="figcaption">Cell Gate</div>
</div>
<div class="float">
<img src="figures/Workflow/bead_gate.jpg" alt="Bead Gate"><div class="figcaption">Bead Gate</div>
</div>
<p>If everything looks okay with the gating, we proceed to control
clean-up. This helps remove noisy events, like autofluorescence spikes,
and tries to match the positive events for each control to corresponding
cells/beads in the unstained <code>universal.negative</code> that you
defined in the control.file.</p>
<p>The default settings here are usually best. See more on the cleaning
article on <a href="https://drcytometer.github.io/AutoSpectral/articles/05_Cleaning.html">GitHub</a>
or <a href="https://www.colibri-cytometry.com/post/autospectral-cleaning" class="external-link">Colibri</a>.
There is a parallelization option, which is being converted to the new
parallel backend. Once that is in place, it should be faster.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flow.control</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clean.controls.html">clean.controls</a></span><span class="op">(</span><span class="va">flow.control</span>, <span class="va">asp</span><span class="op">)</span></span></code></pre></div>
<p>There are lots of plots generated with this, in
<code>figure_clean_controls</code> and in
<code>figure_spectral_ribbon</code>.</p>
<p>Now we can isolate the spectra from the controls. By default, this
uses the cleaned data if they are available.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spectra</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.fluorophore.spectra.html">get.fluorophore.spectra</a></span><span class="op">(</span><span class="va">flow.control</span>, <span class="va">asp</span><span class="op">)</span></span></code></pre></div>
<p>With this, we get plots of the spectra as traces and a heatmap. We
also get a cosine similarity heatmap. You can check these, if you aren’t
familiar with what they should look like, against the expected profiles
in online webtools. For the Aurora, check on Cytek Cloud.</p>
<p><img src="figures/Workflow/spectral_trace.jpg" alt="Spectral Trace"><img src="figures/Workflow/spectral_heatmap.jpg" alt="Spectral Heatmap"><img src="figures/Workflow/similarity_matrix.jpg" alt="Similarity Matrix"></p>
<p>The spectra themselves are saved to a CSV file in the
<code>table_spectra</code> folder. You can open CSV files as a
spreadsheet in Excel and other programs.</p>
</div>
<div class="section level2">
<h2 id="now-on-to-unmixing-">Now, on to unmixing.<a class="anchor" aria-label="anchor" href="#now-on-to-unmixing-"></a>
</h2>
<p>AutoSpectral provides options for unmixing. Let’s start with the most
basic, which is replicating the OLS unmixing as in SpectroFlo.
Autofluorescence extraction with OLS and WLS unmixing in AutoSpectral is
handled by including an “AF” signature in <code>spectra</code>. This is
generated automatically from the unstained cell control sample that is
tagged as “AF” in your <code>control.file</code>. We can use OLS or WLS
without autofluorescence extraction by removing this row from the
<code>spectra</code> matrix before we pass it to the unmixing call. Here
are two easy ways to do that: 1) subset <code>spectra</code> 2) read in
the CSV file in <code>table_spectra</code>, removing the AF channel</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">spectra</span><span class="op">)</span></span>
<span><span class="va">no.af.spectra</span> <span class="op">&lt;-</span> <span class="va">spectra</span><span class="op">[</span> <span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">spectra</span><span class="op">)</span> <span class="op">==</span> <span class="st">"AF"</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">no.af.spectra</span><span class="op">)</span></span>
<span><span class="va">no.af.spectra.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read.spectra.html">read.spectra</a></span><span class="op">(</span><span class="st">"Clean_autospectral_spectra.csv"</span>,</span>
<span>                                remove.af <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">no.af.spectra.2</span><span class="op">)</span></span></code></pre></div>
<p>To unmix, specify the file (and path) of the FCS file you want to
unmix:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spleen.fcs.file</span> <span class="op">&lt;-</span> <span class="st">"./Raw/Set1/Stained/D4 Spleen_Set1.fcs"</span></span>
<span><span class="fu"><a href="../reference/unmix.fcs.html">unmix.fcs</a></span><span class="op">(</span></span>
<span>  <span class="va">spleen.fcs.file</span>,</span>
<span>  <span class="va">spectra</span>, <span class="va">asp</span>,</span>
<span>  <span class="va">flow.control</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"OLS"</span>,</span>
<span>  file.suffix <span class="op">=</span> <span class="st">"with AF extraction"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/unmix.fcs.html">unmix.fcs</a></span><span class="op">(</span></span>
<span>  <span class="va">spleen.fcs.file</span>,</span>
<span>  <span class="va">no.af.spectra</span>,</span>
<span>  <span class="va">asp</span>,</span>
<span>  <span class="va">flow.control</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"OLS"</span>,</span>
<span>  file.suffix <span class="op">=</span> <span class="st">"without AF extraction"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that this is just using OLS–this is not the “AutoSpectral”
unmixing method, we are just using the AutoSpectral R package to perform
bog standard unmixing.</p>
<p>If we have a folder full of FCS files, we can do all the files in the
folder. Note that this is essentially just an <code>lapply</code> loop
over the files. It can, however, be parallelized, which will work as
long as you have enough memory to handle the number of threads
multiplied by the size of the files. So, if your FCS files are ~100MB,
fine, if they’re multiple GB, maybe not. May not be much faster.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/unmix.folder.html">unmix.folder</a></span><span class="op">(</span><span class="st">"./Raw/Set1/Stained/"</span>, <span class="va">spectra</span>, <span class="va">asp</span>, <span class="va">flow.control</span>, </span>
<span>             method <span class="op">=</span> <span class="st">"OLS"</span>, parallel <span class="op">=</span> <span class="cn">TRUE</span>, threads <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p>By default, the unmixed files are generated in
<code>Autospectral_unmixed</code>, but you can change that by passing a
path to <code>output.dir</code>.</p>
<p>If we want to use weighted least-squares, we call like this:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/unmix.fcs.html">unmix.fcs</a></span><span class="op">(</span><span class="va">spleen.fcs.file</span>, <span class="va">spectra</span>, <span class="va">asp</span>, <span class="va">flow.control</span>, method <span class="op">=</span> <span class="st">"WLS"</span><span class="op">)</span></span></code></pre></div>
<p>The <code>method</code> is automatically appended to the output file
name.</p>
<p>Okay, that’s basic unmixing. And, I think you should see a bit of
improvement using AutoSpectral even with the same unmixing algorithms
due to the improvements in single-colour control handling. We do.</p>
</div>
<div class="section level2">
<h2 id="per-cell-unmixing">Per-cell unmixing<a class="anchor" aria-label="anchor" href="#per-cell-unmixing"></a>
</h2>
<p>For per-cell autofluorescence extraction and per-cell fluorophore
optimization, AutoSpectral needs more information. We will extract
autofluorescence signatures from the three tissues involved here, and
look at how to use those in the unmixing. We’ll also get information
about the fluorophore emission variability and use that to try to
improve the unmixing.</p>
<p>When we go to use this information in the unmixing, we select
<code>method = AutoSpectral</code>.</p>
<p>As of version 1.0.0, per-cell autofluorescence extraction will be
faster using <code>AutoSpectralRcpp</code>. On Windows, you will first
need to install Rtools.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"DrCytometer/AutoSpectralRcpp"</span><span class="op">)</span></span></code></pre></div>
<p>Once <code>AutoSpectralRcpp</code> is installed, it takes over when
the unmixing starts. You don’t need to do anything else.</p>
<p>To use per-cell autofluorescence extraction only, no fluorophore
optimization, do this:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spleen.unstained</span> <span class="op">&lt;-</span> <span class="st">"./Raw/Set1/Unstained/D1 Spleen_Set1.fcs"</span></span>
<span><span class="va">spleen.af</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.af.spectra.html">get.af.spectra</a></span><span class="op">(</span><span class="va">spleen.unstained</span>, <span class="va">asp</span>, <span class="va">spectra</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/unmix.fcs.html">unmix.fcs</a></span><span class="op">(</span></span>
<span>  <span class="va">spleen.fcs.file</span>,</span>
<span>  <span class="va">spectra</span>,</span>
<span>  <span class="va">asp</span>,</span>
<span>  <span class="va">flow.control</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"AutoSpectral"</span>,</span>
<span>  af.spectra <span class="op">=</span> <span class="va">spleen.af</span>,</span>
<span>  file.suffix <span class="op">=</span> <span class="st">"per-cell AF extraction"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We get the distribution of autofluorescence spectra as a spectral
trace and as a heatmap in <code>figure_autofluorescence</code>. The AF
spectra are saved as a CSV file in <code>table_spectra</code>.</p>
<div class="float">
<img src="figures/Workflow/spleen_af_variation.jpg" alt="Spleen AF"><div class="figcaption">Spleen AF</div>
</div>
<p>If you want to do this with samples containing different
autofluorescence profiles, such as we have here, we extract the AF
spectral variation from each type of unstained sample. We then provide
the corresponding <code>af.spectra</code> to each unmixing call. The
unmixing call can be to a single FCS file, or it can be, as above, to a
folder. So, if you have a whole set of stained lung samples, you’d pull
your AF spectra from the unstained lung sample, and then call
<code>unmix.folder</code> on the folder containing your lung (and only
lung) samples. Repeat for each type of autofluorescence sample. Read
more about how the per-cell autofluorescence extraction works in the <a href="https://drcytometer.github.io/AutoSpectral/articles/08_Single_Cell_AutoFluorescence.html">GitHub</a>
or <a href="https://www.colibri-cytometry.com/post/autospectral-single-cell-autofluorescence" class="external-link">Colibri</a>
article.</p>
<p>In this case, we have three types of samples: spleen, liver and lung
tissues. If you are working with human PBMCs, usually a single
(optionally pooled) unstained PBMC sample is fine. If, however, you have
samples from very sick donors, you might consider collecting unstained
sample from each donor and matching the autofluorescence more
closely.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lung.unstained</span> <span class="op">&lt;-</span> <span class="st">"./Raw/Set1/Unstained/D2 Lung_Set1.fcs"</span></span>
<span><span class="va">lung.af</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.af.spectra.html">get.af.spectra</a></span><span class="op">(</span><span class="va">lung.unstained</span>, <span class="va">asp</span>, <span class="va">spectra</span><span class="op">)</span></span>
<span><span class="va">lung.fcs.file</span> <span class="op">&lt;-</span> <span class="st">"./Raw/Set1/Stained/D5 Lung_Set1.fcs"</span></span>
<span><span class="fu"><a href="../reference/unmix.fcs.html">unmix.fcs</a></span><span class="op">(</span></span>
<span>  <span class="va">lung.fcs.file</span>,</span>
<span>  <span class="va">spectra</span>,</span>
<span>  <span class="va">asp</span>,</span>
<span>  <span class="va">flow.control</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"AutoSpectral"</span>,</span>
<span>  af.spectra <span class="op">=</span> <span class="va">lung.af</span>,</span>
<span>  file.suffix <span class="op">=</span> <span class="st">"per-cell AF extraction"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">liver.unstained</span> <span class="op">&lt;-</span> <span class="st">"./Raw/Set1/Unstained/D3 Liver_Set1.fcs"</span></span>
<span><span class="va">liver.af</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.af.spectra.html">get.af.spectra</a></span><span class="op">(</span><span class="va">liver.unstained</span>, <span class="va">asp</span>, <span class="va">spectra</span><span class="op">)</span></span>
<span><span class="va">liver.fcs.file</span> <span class="op">&lt;-</span> <span class="st">"./Raw/Set1/Stained/D6 Liver_Set1.fcs"</span></span>
<span><span class="fu"><a href="../reference/unmix.fcs.html">unmix.fcs</a></span><span class="op">(</span></span>
<span>  <span class="va">liver.fcs.file</span>,</span>
<span>  <span class="va">spectra</span>,</span>
<span>  <span class="va">asp</span>,</span>
<span>  <span class="va">flow.control</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"AutoSpectral"</span>,</span>
<span>  af.spectra <span class="op">=</span> <span class="va">liver.af</span>,</span>
<span>  file.suffix <span class="op">=</span> <span class="st">"per-cell AF extraction"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>To do per-cell fluorophore optimization, we will first measure the
variation in the spectrum for each fluorophore. For the unmixing, we’ll
supply the <code>af.spectra</code> and the
<code>spectra.variants</code>, calling <code>AutoSpectral</code>
unmixing. Read more about how the per-cell fluorophore optimization
works in the <a href="https://drcytometer.github.io/AutoSpectral/articles/09_Per_Cell_Optimization.html">GitHub</a>
or <a href="https://www.colibri-cytometry.com/post/autospectral-per-cell-fluorophore-optimization" class="external-link">Colibri</a>
article.</p>
<p>We provide <code>spleen.af</code> as the <code>af.spectra</code> here
because the control samples are from spleen. Provide whatever is the
best fit for your single-stained controls. The point here is to match
the AF of the controls so that we isolate the variation in the
fluorophore signatures independent of any AF variation.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">variants</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.spectral.variants.html">get.spectral.variants</a></span><span class="op">(</span></span>
<span>  <span class="va">control.dir</span>,</span>
<span>  <span class="va">control.file</span>,</span>
<span>  <span class="va">asp</span>,</span>
<span>  <span class="va">spectra</span>,</span>
<span>  af.spectra <span class="op">=</span> <span class="va">spleen.af</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The output of this is saved as an RDS file in folder
<code>figure_spectral_variants</code>. You can load it back in using the
<code><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS()</a></code> function in base R.</p>
<p>There are plots of the spectral variation for each fluorophore. For
something like the CD11b-BUV805 in this data, the variation is largely
changes in the autofluorescence because there are multiple cell types
expressing CD11b. <img src="figures/Workflow/BUV805_variants.jpg" alt="BUV805"></p>
<p>For PE-Cy7, we get a modest difference in the excitation between the
blue and yellow-green lasers, which would cause spread if we had a
fluorophore in that range on the blue laser, such as RB780. We don’t in
this case. <img src="figures/Workflow/PECy7_variants.jpg" alt="PE-Cy7"></p>
<p>We can now pass this to the unmixing call. For quicker results, we’ll
set the <code>speed</code> to <code>fast</code>, which checks fewer
pre-screened variants per cell. This can be a bit slow. Parallelization
is automatic here if you have installed <code>AutoSpectralRcpp</code>.
If you are using base R only, try turning on the
<code>parallel=TRUE</code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/unmix.fcs.html">unmix.fcs</a></span><span class="op">(</span></span>
<span>  <span class="va">lung.fcs.file</span>,</span>
<span>  <span class="va">spectra</span>,</span>
<span>  <span class="va">asp</span>,</span>
<span>  <span class="va">flow.control</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"AutoSpectral"</span>,</span>
<span>  af.spectra <span class="op">=</span> <span class="va">lung.af</span>,</span>
<span>  spectra.variants <span class="op">=</span> <span class="va">variants</span>,</span>
<span>  file.suffix <span class="op">=</span> <span class="st">"per-cell AF and fluorophore optimization"</span>,</span>
<span>  speed <span class="op">=</span> <span class="st">"fast"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Please note that if you are comparing the output FCS files from
AutoSpectral to others you may have from the cytometer and you are doing
this in FlowJo, FlowJo V10 is still terrible at handling scales. You
must set the transformations on the axes to be the same for all
coefficients in order to do a fair comparison. Otherwise you’ll see
whatever you’ve already done to tune your display (e.g., biexponential
width basis) for your existing files versus some random default
selection by FlowJo for AutoSpectral’s files. Nothing to do with me.</p>
<p>You can do a comparison using the plotting functions in AutoSpectral,
but a dedicated flow cytometry analysis program with a graphical
interface will be better. More on plotting on the dedicated article on
<a href="https://drcytometer.github.io/AutoSpectral/articles/09_Plotting.html">GitHub</a>
or <a href="https://www.colibri-cytometry.com/post/autospectral-plotting" class="external-link">Colibri</a>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">autospectral.unmixed.lung</span> <span class="op">&lt;-</span> <span class="st">"AutoSpectral_unmixed/D5 Lung_Set1 AutoSpectral per-cell AF and fluorophore optimization.fcs"</span></span>
<span><span class="va">spectroflo.unmixed.lung</span> <span class="op">&lt;-</span> <span class="st">"./Unmixed/Set1/Stained/D5 Lung_Set1.fcs"</span></span>
<span></span>
<span><span class="va">asp.lung</span> <span class="op">&lt;-</span> <span class="fu">flowCore</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/exprs.html" class="external-link">exprs</a></span><span class="op">(</span></span>
<span>  <span class="fu">flowCore</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/read.FCS.html" class="external-link">read.FCS</a></span><span class="op">(</span><span class="va">autospectral.unmixed.lung</span>,</span>
<span>                     truncate_max_range <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">sf.lung</span> <span class="op">&lt;-</span> <span class="fu">flowCore</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/exprs.html" class="external-link">exprs</a></span><span class="op">(</span></span>
<span>  <span class="fu">flowCore</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/read.FCS.html" class="external-link">read.FCS</a></span><span class="op">(</span><span class="va">spectroflo.unmixed.lung</span>,</span>
<span>                     truncate_max_range <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/create.biplot.html">create.biplot</a></span><span class="op">(</span><span class="va">sf.lung</span>, <span class="st">"BUV395-A"</span>, <span class="st">"BV421-A"</span>, <span class="va">asp</span>, title <span class="op">=</span> <span class="st">"SpectroFlo"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/create.biplot.html">create.biplot</a></span><span class="op">(</span><span class="va">asp.lung</span>, <span class="st">"BUV395"</span>, <span class="st">"BV421"</span>, <span class="va">asp</span>, title <span class="op">=</span> <span class="st">"AutoSpectral"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/Workflow/SpectroFlo.jpg" alt="SpectroFlo"><img src="figures/Workflow/AutoSpectral.jpg" alt="AutoSpectral"></p>
<p>Here we have CD45-BUV395 and CD4-BV421. There really shouldn’t be
much of anything low for CD4 in the mouse.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Oliver Burton, Adrian Liston.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
